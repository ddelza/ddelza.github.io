<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì „ë ¥ëŸ‰ ê´€ë¦¬ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            display: grid;
            grid-template-areas:
                "header header header"
                "shop workspace controls";
            grid-template-columns: 2fr 5fr 2fr;
            gap: 1.5rem;
            max-width: 1200px;
            width: 100%;
        }

        .header { grid-area: header; }
        .shop { grid-area: shop; }
        .workspace { grid-area: workspace; }
        .controls { grid-area: controls; }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-areas:
                    "header header"
                    "workspace workspace"
                    "shop controls";
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-areas:
                    "header"
                    "shop"
                    "workspace"
                    "controls";
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background-color: #2d3748;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .machine-item {
            cursor: grab;
            transition: transform 0.2s ease-in-out;
        }

        .machine-item:active {
            cursor: grabbing;
        }

        /* ê·¸ë¦¬ë“œ ì‹œê° íš¨ê³¼ ê°œì„  */
        .grid-cell {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #2d3748;
            transition: background-color 0.1s;
            border-radius: 0.25rem;
            box-shadow: inset 0 0 0 1px #4a5568;
            aspect-ratio: 1 / 1;
        }

        .grid-cell.occupied {
            background-color: #4c51bf;
        }

        .machine {
            background-color: #63b3ed;
            border-radius: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 0.875rem;
            cursor: grab;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        
        .machine:hover {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        
        .machine:active {
            cursor: grabbing;
        }

        .drag-over {
            background-color: #4a5568;
            border: 2px dashed #a0aec0;
        }

        .button-group button {
            transition: transform 0.1s ease-in-out;
        }
        
        .button-group button:hover {
            transform: translateY(-2px);
        }
        
        .temporary-message {
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             color: white;
             font-weight: bold;
             padding: 0.5rem 1rem;
             border-radius: 0.5rem;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             z-index: 100;
             transition: opacity 0.3s ease-in-out;
             text-align: center;
        }
        
        .temporary-message.success {
            background-color: #48bb78;
        }
        
        .temporary-message.error {
            background-color: #e53e3e;
        }
        
        .game-over-message, .win-message {
            background-color: #e53e3e;
            font-size: 1.5rem;
            padding: 2rem;
            border-radius: 1rem;
            text-align: center;
            font-weight: bold;
            opacity: 1 !important;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .win-message {
            background-color: #38a169;
        }

        .game-restart-btn {
            background-color: #2b6cb0;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }

        .game-restart-btn:hover {
            background-color: #3182ce;
        }

        /* ì‘ì—…ì¥ UI ì—¬ë°± ì œê±° ë° ê·¸ë¦¬ë“œ ë¹„ìœ¨ ê³ ì • */
        .workspace {
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
        }
        
        .workspace #grid-container {
            width: 100%;
            height: 100%; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆì˜ ë†’ì´ë¥¼ ì°¨ì§€í•˜ë„ë¡ ìˆ˜ì • */
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            grid-template-rows: repeat(6, 1fr); /* ëª…ì‹œì ìœ¼ë¡œ 6ê°œ í–‰ì„ ì •ì˜ */
            gap: 0;
        }
        
        .workspace #grid-container .grid-cell {
            /* ë³„ë„ í¬ì§€ì…”ë‹ ì†ì„± ì‚­ì œ */
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container min-h-screen p-4">
        <!-- ìƒë‹¨ ì •ë³´ UI -->
        <div class="header panel flex justify-between items-center text-sm lg:text-base flex-wrap gap-2">
            <div>ë³´ìœ ê¸ˆì•¡: <span id="money" class="font-bold text-yellow-400">1000ì›</span></div>
            <div>ì§„í–‰ ì¼ ìˆ˜: <span id="days" class="font-bold text-blue-400">0ì¼</span></div>
            <div>ì „ë ¥ ì‚¬ìš©ëŸ‰: <span id="powerUsage" class="font-bold text-red-400">0kWh</span></div>
            <div>ì§€ë‚œë‹¬ ì „ë ¥ ì‚¬ìš©ëŸ‰: <span id="lastMonthPower" class="font-bold text-red-400">0kWh</span></div>
            <div>ë‹¤ìŒ ì „ê¸°ì„¸ê¹Œì§€: <span id="daysUntilBill" class="font-bold text-green-400">30ì¼</span></div>
        </div>

        <!-- ì¢Œì¸¡ ê¸°ê³„ êµ¬ë§¤ UI -->
        <div class="shop panel" id="shop-panel">
            <h2 class="text-xl font-bold mb-4 text-center">ê¸°ê³„ êµ¬ë§¤</h2>
            <div id="machine-list" class="flex flex-col gap-4">
                <!-- ê¸°ê³„ ëª©ë¡ì€ JSë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ì¤‘ì•™ ì‘ì—…ì¥ UI -->
        <div class="workspace panel">
            <div id="grid-container" class="relative">
                <!-- ê·¸ë¦¬ë“œ ì…€ì€ JSë¡œ ë™ì  ìƒì„± -->
            </div>
        </div>

        <!-- ìš°ì¸¡ í†µê³„ ë° ì œì–´ UI -->
        <div class="controls panel flex flex-col justify-between">
            <div class="flex flex-col gap-2 text-sm lg:text-base">
                <h2 class="text-xl font-bold mb-4 text-center">í†µê³„</h2>
                <div>ì´ ìˆ˜ì…: <span id="total-income" class="font-bold text-green-400">0ì›</span></div>
                <div>ì´ ì „ê¸°ì„¸: <span id="total-bill" class="font-bold text-red-400">0ì›</span></div>
                <div>ì´ ê¸°ê³„ êµ¬ì…ë¹„: <span id="total-machine-cost" class="font-bold text-red-400">0ì›</span></div>
                <div>ìˆœìˆ˜ìµ: <span id="net-profit" class="font-bold text-yellow-400">0ì›</span></div>
                
                <!-- ë²„íŠ¼ì„ í†µê³„ ë°”ë¡œ ì•„ë˜ë¡œ ì´ë™ -->
                <div class="button-group flex flex-col gap-4 mt-4">
                    <button id="next-day-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
                        í•˜ë£¨ ë³´ë‚´ê¸°
                    </button>
                    <button id="next-month-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-colors">
                        í•œë‹¬ ë³´ë‚´ê¸°
                    </button>
                </div>

                <!-- ëˆ„ì§„ì„¸ ê¸°ì¤€ ì •ë³´ ì¶”ê°€ -->
                <div class="mt-4 p-4 rounded-lg bg-gray-700">
                    <p class="text-xs text-gray-400 font-bold mb-2">
                        ì „ê¸°ì„¸ ëˆ„ì§„ì„¸ ìš”ê¸ˆ ê¸°ì¤€
                    </p>
                    <ul class="text-xs text-gray-400 list-disc list-inside">
                        <li>~ 200kWh ì´í•˜: 120ì›/kWh</li>
                        <li>200kWh ì´ˆê³¼ ~ 400kWh ì´í•˜: 215ì›/kWh</li>
                        <li>400kWh ì´ˆê³¼: 300ì›/kWh</li>
                    </ul>
                </div>

                <!-- ê²Œì„ ëª©í‘œ ì„¤ëª… ì¶”ê°€ -->
                <div class="mt-4 p-4 rounded-lg bg-gray-700">
                    <p class="mt-2 text-xs text-gray-400 leading-relaxed">
                        ğŸ’° ê²Œì„ ëª©í‘œ: 2ë…„(730ì¼) ë™ì•ˆ íŒŒì‚°í•˜ì§€ ì•Šê³  ìµœëŒ€í•œ ë§ì€ ìˆœìˆ˜ìµì„ ë‹¬ì„±í•˜ì„¸ìš”!
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ì„ì‹œ ë©”ì‹œì§€ ë° íŒŒì‚° ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ -->
    <div id="message-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ê²Œì„ ìƒíƒœ ë³€ìˆ˜
            let money;
            let day;
            let currentMonthKwh;
            let lastMonthKwh;
            let daysUntilBill;
            let totalIncome;
            let totalBill;
            let totalMachineCost;
            let machineCounter; // Unique ID for each machine instance
            const WIN_CONDITION_DAYS = 730;

            const gridWidth = 5;
            const gridHeight = 6;
            let workspaceGrid;

            // UI ìš”ì†Œ
            const moneyEl = document.getElementById('money');
            const daysEl = document.getElementById('days');
            const powerUsageEl = document.getElementById('powerUsage');
            const lastMonthPowerEl = document.getElementById('lastMonthPower');
            const daysUntilBillEl = document.getElementById('daysUntilBill');
            const totalIncomeEl = document.getElementById('total-income');
            const totalBillEl = document.getElementById('total-bill');
            const totalMachineCostEl = document.getElementById('total-machine-cost');
            const netProfitEl = document.getElementById('net-profit');
            const machineListEl = document.getElementById('machine-list');
            const gridContainer = document.getElementById('grid-container');
            const nextDayBtn = document.getElementById('next-day-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const messageContainer = document.getElementById('message-container');
            const shopPanel = document.getElementById('shop-panel');

            // ê¸°ê³„ ì •ë³´
            const machines = {
                'rat': { name: 'ì¥', price: 500, power: 40, income: 200, size: [1, 1], emoji: 'ğŸ­' },
                'cow': { name: 'ì†Œ', price: 1500, power: 100, income: 550, size: [1, 2], emoji: 'ğŸ®' },
                'rabbit': { name: 'í† ë¼', price: 1200, power: 70, income: 400, size: [3, 1], emoji: 'ğŸ°' },
                'tiger': { name: 'í˜¸ë‘ì´', price: 5000, power: 180, income: 1000, size: [2, 2], emoji: 'ğŸ¯' },
                'dragon': { name: 'ìš©', price: 8000, power: 400, income: 2200, size: [2, 3], emoji: 'ğŸ‰' },
            };

            // ë“œë˜ê·¸ ìƒíƒœ ê´€ë¦¬
            let draggedMachineId = null;
            let draggedMachineInstance = null;
            let isGameOver = false;
            let fastForwardInterval = null;
            let pressTimer = null;

            // UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
            const updateUI = () => {
                moneyEl.textContent = `${money.toLocaleString()}ì›`;
                daysEl.textContent = `${day}ì¼ (${day}/${WIN_CONDITION_DAYS})`;
                powerUsageEl.textContent = `${(currentMonthKwh).toFixed(2)}kWh`;
                lastMonthPowerEl.textContent = `${(lastMonthKwh).toFixed(2)}kWh`;
                daysUntilBillEl.textContent = `${daysUntilBill}ì¼`;
                totalIncomeEl.textContent = `${totalIncome.toLocaleString()}ì›`;
                totalBillEl.textContent = `${totalBill.toLocaleString()}ì›`;
                totalMachineCostEl.textContent = `${totalMachineCost.toLocaleString()}ì›`;
                const netProfit = totalIncome - totalBill - totalMachineCost;
                netProfitEl.textContent = `${netProfit.toLocaleString()}ì›`;
            };

            // ì¼ì¼ ìˆ˜ì… ê³„ì‚°
            const calculateDailyIncome = () => {
                let dailyIncome = 0;
                const processedInstances = new Set();
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        const machineInstance = workspaceGrid[y][x];
                        if (machineInstance && !processedInstances.has(machineInstance.instanceId)) {
                            processedInstances.add(machineInstance.instanceId);
                            dailyIncome += machines[machineInstance.id].income;
                        }
                    }
                }
                return dailyIncome;
            };

            // ì¼ì¼ ì „ë ¥ ì†Œë¹„ ê³„ì‚°
            const calculateDailyPower = () => {
                let dailyPower = 0;
                const processedInstances = new Set();
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        const machineInstance = workspaceGrid[y][x];
                        if (machineInstance && !processedInstances.has(machineInstance.instanceId)) {
                            processedInstances.add(machineInstance.instanceId);
                            dailyPower += machines[machineInstance.id].power;
                        }
                    }
                }
                return dailyPower * 24 / 1000;
            };

            // ì „ê¸°ì„¸ ê³„ì‚° (ë‹¨ì¼ ìš”ìœ¨)
            const calculateElectricityBill = (kwh) => {
                if (kwh <= 200) {
                    return kwh * 120;
                } else if (kwh <= 400) {
                    return kwh * 215;
                } else {
                    return kwh * 300;
                }
            };

            // ê²Œì„ ì¢…ë£Œ(íŒŒì‚°) ì²˜ë¦¬
            const endGame = () => {
                isGameOver = true;
                nextDayBtn.disabled = true;
                nextMonthBtn.disabled = true;
                nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nextMonthBtn.classList.add('opacity-50', 'cursor-not-allowed');

                // ë§ˆì§€ë§‰ ì „ê¸°ì„¸ ì •ì‚°
                const finalBill = calculateElectricityBill(currentMonthKwh);
                money -= finalBill;
                totalBill += finalBill;
                lastMonthKwh = currentMonthKwh; // ë§ˆì§€ë§‰ ë‹¬ ì „ë ¥ëŸ‰ ì €ì¥
                currentMonthKwh = 0;
                updateUI();
                
                showTemporaryMessage(
                    `íŒŒì‚°í–ˆìŠµë‹ˆë‹¤!<br>ìµœì¢… ë³´ìœ  ê¸ˆì•¡: ${money.toLocaleString()}ì›<br>ì´ ê¸°ê³„ êµ¬ì…ë¹„: ${totalMachineCost.toLocaleString()}ì›<br>ì´ ì „ê¸°ì„¸: ${totalBill.toLocaleString()}ì›`,
                    'game-over-message'
                );
            };

            // ê²Œì„ ìŠ¹ë¦¬ ì²˜ë¦¬
            const winGame = () => {
                isGameOver = true;
                nextDayBtn.disabled = true;
                nextMonthBtn.disabled = true;
                nextDayBtn.classList.add('opacity-50', 'cursor-not-allowed');
                nextMonthBtn.classList.add('opacity-50', 'cursor-not-allowed');

                const totalCost = totalBill + totalMachineCost;
                const netProfit = totalIncome - totalCost;
                
                showTemporaryMessage(
                    `ì¶•í•˜í•©ë‹ˆë‹¤! 2ë…„ ë™ì•ˆ íŒŒì‚°í•˜ì§€ ì•Šê³  ì‚´ì•„ë‚¨ìœ¼ì…¨ìŠµë‹ˆë‹¤.<br><br>
                    ìˆœìˆ˜ìµ: ${netProfit.toLocaleString()}ì›<br>
                    ì´ ìˆ˜ì…: ${totalIncome.toLocaleString()}ì›<br>
                    ì´ ì†Œë¹„: ${totalCost.toLocaleString()}ì›`,
                    'win-message'
                );
            };

            // í•˜ë£¨ ì§„í–‰
            const nextDay = () => {
                if (isGameOver) return;
                
                day++;
                const dailyIncome = calculateDailyIncome();
                const dailyPower = calculateDailyPower();

                money += dailyIncome;
                totalIncome += dailyIncome;
                currentMonthKwh += dailyPower;
                daysUntilBill--;

                // ê²Œì„ ìŠ¹ë¦¬ ì¡°ê±´ í™•ì¸
                if (day === WIN_CONDITION_DAYS) {
                    winGame();
                    return;
                }

                // í•œ ë‹¬ ì •ì‚°
                if (daysUntilBill <= 0) {
                    const billAmount = calculateElectricityBill(currentMonthKwh);
                    money -= billAmount;
                    totalBill += billAmount;
                    lastMonthKwh = currentMonthKwh; // ì§€ë‚œ ë‹¬ ì „ë ¥ëŸ‰ ì—…ë°ì´íŠ¸
                    currentMonthKwh = 0;
                    daysUntilBill = 30;
                }
                
                // íŒŒì‚° ì—¬ë¶€ í™•ì¸
                if (money < 0) {
                    endGame();
                    return;
                }

                updateUI();
            };

            // ê¸°ê³„ ëª©ë¡ UI ìƒì„±
            const createMachineListUI = () => {
                machineListEl.innerHTML = '';
                for (const id in machines) {
                    const machine = machines[id];
                    const item = document.createElement('div');
                    item.id = `buy-${id}`;
                    item.className = 'machine-item flex items-center bg-gray-700 p-4 rounded-lg shadow-md hover:bg-gray-600 transition-colors cursor-pointer';
                    item.setAttribute('draggable', 'true');
                    item.setAttribute('data-machine-id', id);
                    
                    const sizeText = `${machine.size[0]}x${machine.size[1]}`;

                    item.innerHTML = `
                        <span class="text-4xl mr-4">${machine.emoji}</span>
                        <div class="flex-1">
                            <h3 class="font-bold text-lg">${machine.name} (${sizeText})</h3>
                            <p class="text-sm text-gray-400">ê°€ê²©: ${machine.price.toLocaleString()}ì›</p>
                            <p class="text-sm text-gray-400">ì†Œë¹„ì „ë ¥: ${machine.power}W</p>
                            <p class="text-sm text-gray-400">ì¼ì¼ ìˆ˜ì…: ${machine.income.toLocaleString()}ì›</p>
                        </div>
                    `;
                    item.addEventListener('dragstart', (e) => {
                        draggedMachineId = id;
                        e.dataTransfer.setData('text/plain', id);
                    });
                    machineListEl.appendChild(item);
                }
            };
            
            // ê¸°ê³„ êµ¬ë§¤
            const buyMachine = (machineId) => {
                 const machine = machines[machineId];
                 if (money >= machine.price) {
                     return true;
                 } else {
                     showTemporaryMessage("ëˆì´ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'error');
                     return false;
                 }
            };

            let messageTimeout = null;
            const showTemporaryMessage = (message, type) => {
                if (type === 'game-over-message' || type === 'win-message') {
                    const messageEl = document.createElement('div');
                    messageEl.className = `temporary-message ${type}`;
                    messageEl.innerHTML = message;

                    const restartBtn = document.createElement('button');
                    restartBtn.textContent = 'ë‹¤ì‹œ ì‹œì‘';
                    restartBtn.className = 'game-restart-btn';
                    restartBtn.addEventListener('click', startGame);

                    messageEl.appendChild(restartBtn);
                    messageContainer.innerHTML = '';
                    messageContainer.appendChild(messageEl);
                    return;
                }

                if (messageTimeout) clearTimeout(messageTimeout);
                
                const messageEl = document.createElement('div');
                messageEl.className = `temporary-message ${type}`;
                messageEl.innerHTML = message;
                
                messageContainer.innerHTML = '';
                messageContainer.appendChild(messageEl);

                setTimeout(() => messageEl.style.opacity = '1', 10);
                messageTimeout = setTimeout(() => {
                    messageEl.style.opacity = '0';
                    setTimeout(() => messageEl.remove(), 300);
                }, 2000);
            };

            // ê·¸ë¦¬ë“œ ìƒì„±
            const createGrid = () => {
                gridContainer.innerHTML = '';
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        cell.setAttribute('data-x', x);
                        cell.setAttribute('data-y', y);
                        gridContainer.appendChild(cell);
                    }
                }
            };

            // ê³µê°„ í™•ì¸
            const isSpaceAvailable = (x, y, size) => {
                const [width, height] = size;
                if (x + width > gridWidth || y + height > gridHeight) {
                    return false;
                }
                for (let i = 0; i < width; i++) {
                    for (let j = 0; j < height; j++) {
                        if (workspaceGrid[y + j][x + i] !== null) {
                            return false;
                        }
                    }
                }
                return true;
            };
            
            // ê·¸ë¦¬ë“œì— ê¸°ê³„ ë Œë”ë§
            const renderMachinesOnGrid = () => {
                // ê¸°ì¡´ ê¸°ê³„ ìš”ì†Œ ëª¨ë‘ ì œê±°
                gridContainer.querySelectorAll('.machine').forEach(el => el.remove());
                const renderedInstances = new Set();
                
                // ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆì˜ ê°€ë¡œ/ì„¸ë¡œ ë¹„ìœ¨ì„ ì‚¬ìš©í•˜ì—¬ ì…€ í¬ê¸° ê³„ì‚°
                const gridRect = gridContainer.getBoundingClientRect();
                const cellSize = gridRect.width / gridWidth;
                
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        const machineInstance = workspaceGrid[y][x];
                        // If there's a machine and we haven't rendered this specific instance yet
                        if (machineInstance && !renderedInstances.has(machineInstance.instanceId)) {
                            renderedInstances.add(machineInstance.instanceId);

                            const machineData = machines[machineInstance.id];
                            const [mWidth, mHeight] = machineData.size;

                            const machineEl = document.createElement('div');
                            machineEl.className = 'machine';
                            machineEl.setAttribute('draggable', 'true');
                            machineEl.setAttribute('data-instance-id', machineInstance.instanceId);
                            
                            const cellX = x * cellSize;
                            const cellY = y * cellSize;
                            const machineWidth = mWidth * cellSize;
                            const machineHeight = mHeight * cellSize;

                            machineEl.style.left = `${cellX}px`;
                            machineEl.style.top = `${cellY}px`;
                            machineEl.style.width = `${machineWidth}px`;
                            machineEl.style.height = `${machineHeight}px`;
                            machineEl.innerHTML = `<span class="text-2xl">${machineData.emoji}</span>`;
                            gridContainer.appendChild(machineEl);
                        }
                    }
                }
            };
            
            // ê¸°ê³„ íŒë§¤
            const sellMachine = (instanceId) => {
                let sold = false;
                let machineId = null;
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        const instance = workspaceGrid[y][x];
                        if (instance && instance.instanceId === instanceId) {
                            machineId = instance.id;
                            workspaceGrid[y][x] = null;
                            sold = true;
                        }
                    }
                }

                if (sold && machineId) {
                    const machinePrice = machines[machineId].price;
                    const sellPrice = Math.floor(machinePrice * 0.7);
                    money += sellPrice;
                    totalMachineCost -= machinePrice; // ê¸°ê³„ êµ¬ì…ë¹„ì—ì„œ ì°¨ê°
                    showTemporaryMessage(`${machines[machineId].name} íŒë§¤: +${sellPrice.toLocaleString()}ì›`, 'success');
                    updateUI();
                    renderMachinesOnGrid();
                }
            };

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            gridContainer.addEventListener('dragstart', (e) => {
                const target = e.target.closest('.machine');
                if (target) {
                    e.stopPropagation();
                    draggedMachineInstance = target.getAttribute('data-instance-id');
                    draggedMachineId = null;
                } else {
                    draggedMachineInstance = null;
                    draggedMachineId = e.dataTransfer.getData('text/plain');
                }
            });

            gridContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                gridContainer.querySelectorAll('.grid-cell').forEach(cell => cell.classList.remove('drag-over'));
                if (draggedMachineId) {
                    const target = e.target.closest('.grid-cell');
                    if (target) {
                        const x = parseInt(target.getAttribute('data-x'));
                        const y = parseInt(target.getAttribute('data-y'));
                        if (isSpaceAvailable(x, y, machines[draggedMachineId].size)) {
                            const [w, h] = machines[draggedMachineId].size;
                            for (let i = 0; i < w; i++) {
                                for (let j = 0; j < h; j++) {
                                    const cellIndex = (y + j) * gridWidth + (x + i);
                                    const cell = gridContainer.children[cellIndex];
                                    if (cell) {
                                        cell.classList.add('drag-over');
                                    }
                                }
                            }
                        }
                    }
                }
            });

            gridContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                gridContainer.querySelectorAll('.grid-cell').forEach(cell => cell.classList.remove('drag-over'));
                const target = e.target.closest('.grid-cell');

                if (target && draggedMachineId) {
                    const x = parseInt(target.getAttribute('data-x'));
                    const y = parseInt(target.getAttribute('data-y'));
                    const machine = machines[draggedMachineId];

                    if (buyMachine(draggedMachineId)) {
                         if (isSpaceAvailable(x, y, machine.size)) {
                            const instance = { id: draggedMachineId, instanceId: `instance_${machineCounter++}` };
                            for (let i = 0; i < machine.size[0]; i++) {
                                for (let j = 0; j < machine.size[1]; j++) {
                                    if (y + j < gridHeight && x + i < gridWidth) {
                                        workspaceGrid[y + j][x + i] = instance;
                                    }
                                }
                            }
                            money -= machine.price;
                            totalMachineCost += machine.price;
                            updateUI();
                            if (money < 0) {
                                endGame();
                            }
                            renderMachinesOnGrid();
                         } else {
                            showTemporaryMessage("ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!", 'error');
                         }
                    }
                }
                draggedMachineId = null;
                draggedMachineInstance = null;
            });
            
            // ìƒì ìœ¼ë¡œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ ì¶”ê°€
            shopPanel.addEventListener('dragover', (e) => {
                e.preventDefault();
                shopPanel.classList.add('drag-over');
            });
            
            shopPanel.addEventListener('dragleave', () => {
                shopPanel.classList.remove('drag-over');
            });

            shopPanel.addEventListener('drop', (e) => {
                e.preventDefault();
                shopPanel.classList.remove('drag-over');
                if (draggedMachineInstance) {
                    sellMachine(draggedMachineInstance);
                    draggedMachineInstance = null;
                }
            });

            // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ (ìŠ¤í˜ì´ìŠ¤ë°”)
            document.addEventListener('keydown', (e) => {
                if (e.code === 'Space' && !isGameOver) {
                    if (!e.repeat) {
                       nextDay();
                       pressTimer = setTimeout(() => {
                           fastForwardInterval = setInterval(nextDay, 50);
                       }, 1000);
                    }
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.code === 'Space') {
                    clearTimeout(pressTimer);
                    clearInterval(fastForwardInterval);
                    fastForwardInterval = null;
                }
            });
            
            // 'í•˜ë£¨ ë³´ë‚´ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸
            nextDayBtn.addEventListener('mousedown', () => {
                if (!isGameOver) {
                    nextDay();
                    pressTimer = setTimeout(() => {
                        fastForwardInterval = setInterval(nextDay, 50);
                    }, 1000);
                }
            });

            document.addEventListener('mouseup', () => {
                if (fastForwardInterval) {
                    clearInterval(fastForwardInterval);
                    fastForwardInterval = null;
                }
                if (pressTimer) {
                    clearTimeout(pressTimer);
                    pressTimer = null;
                }
            });

            // 'í•œë‹¬ ë³´ë‚´ê¸°' ë²„íŠ¼ ì´ë²¤íŠ¸
            nextMonthBtn.addEventListener('click', () => {
                if (isGameOver) return;
                
                for (let i = 0; i < 30; i++) {
                    nextDay();
                    if (isGameOver) break;
                }
            });
            
            // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜
            const startGame = () => {
                isGameOver = false;
                money = 1000;
                day = 0;
                currentMonthKwh = 0;
                lastMonthKwh = 0; // ì§€ë‚œë‹¬ ì „ë ¥ëŸ‰ ì´ˆê¸°í™”
                daysUntilBill = 30;
                totalIncome = 0;
                totalBill = 0;
                totalMachineCost = 0;
                machineCounter = 0;
                workspaceGrid = Array.from({ length: gridHeight }, () => Array(gridWidth).fill(null));
                
                nextDayBtn.disabled = false;
                nextMonthBtn.disabled = false;
                nextDayBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                nextMonthBtn.classList.remove('opacity-50', 'cursor-not-allowed');

                updateUI();
                renderMachinesOnGrid();
                
                messageContainer.innerHTML = ''; // íŒŒì‚° ë©”ì‹œì§€ ì œê±°
                showTemporaryMessage("ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤!", 'success');
            };

            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê²Œì„ ì‹œì‘
            createMachineListUI();
            createGrid();
            startGame();
        });
    </script>
</body>
</html>
